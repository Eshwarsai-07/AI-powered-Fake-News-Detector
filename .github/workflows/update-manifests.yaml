name: Update Kubernetes Manifests

on:
  workflow_run:
    workflows: ["Backend CI", "Frontend CI"]
    types:
      - completed
    branches: [main]

permissions:
  contents: write

jobs:
  update-manifests:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get short SHA
        id: sha
        run: echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Update backend deployment manifest
        if: ${{ github.event.workflow_run.name == 'Backend CI' }}
        run: |
          sed -i "s|image: .*/fake-news-backend:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/fake-news-backend:main-sha-${{ github.sha }}|g" \
            k8s/backend/deployment.yaml

      - name: Update frontend deployment manifest
        if: ${{ github.event.workflow_run.name == 'Frontend CI' }}
        run: |
          sed -i "s|image: .*/fake-news-frontend:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/fake-news-frontend:main-sha-${{ github.sha }}|g" \
            k8s/frontend/deployment.yaml

      - name: Commit and push changes
        run: |
          git add k8s/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update image tags to ${{ steps.sha.outputs.short_sha }}"
            git push
          fi

      - name: Trigger ArgoCD sync (optional)
        if: ${{ secrets.ARGOCD_SERVER != '' }}
        run: |
          echo "ArgoCD will auto-sync the changes"
          # Optionally trigger manual sync:
          # argocd app sync fake-news-detector --server ${{ secrets.ARGOCD_SERVER }}
