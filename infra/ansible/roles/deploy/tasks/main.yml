- name: Clone the repository
  git:
    repo: "{{ repo_url }}"
    dest: /home/ubuntu/ai-fake-news-detector
    force: yes

- name: Create host model directory
  file:
    path: /mnt/data/model
    state: directory
    mode: '0777'
    owner: ubuntu
    group: ubuntu
  become: true

- name: Upload model to S3 from local machine
  command: "aws s3 sync /Users/eshwarsai/Desktop/AI\\ Fake\\ News\\ Detector/model_training/saved_model/fake-news-bert/ s3://{{ model_bucket }}/model/"
  delegate_to: localhost
  become: false
  run_once: true

- name: Install AWS CLI on EC2
  apt:
    name: awscli
    state: present
  become: true

- name: Download model from S3 to EC2
  command: "aws s3 sync s3://{{ model_bucket }}/model/ /mnt/data/model/"
  become: true

- name: Check if Kind cluster exists
  command: kind get clusters
  register: kind_clusters
  changed_when: false

- name: Create Kind cluster if not exists
  command: "kind create cluster --name ai-detector --config /home/ubuntu/ai-fake-news-detector/infra/ansible/kind-config.yaml"
  when: "'ai-detector' not in kind_clusters.stdout"

- name: Install Nginx Ingress Controller
  command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
  when: "'ai-detector' not in kind_clusters.stdout"

- name: Wait for Ingress Controller to be ready
  shell: |
    kubectl wait --namespace ingress-nginx \
      --for=condition=ready pod \
      --selector=app.kubernetes.io/component=controller \
      --timeout=90s
  ignore_errors: yes
  when: "'ai-detector' not in kind_clusters.stdout"

- name: Build Backend Docker image
  docker_image:
    build:
      path: /home/ubuntu/ai-fake-news-detector/backend
    name: fake-news-backend
    tag: latest
    source: build

- name: Build Frontend Docker image
  docker_image:
    build:
      path: /home/ubuntu/ai-fake-news-detector/frontend
    name: fake-news-frontend
    tag: latest
    source: build

- name: Load images into Kind
  command: "kind load docker-image {{ item }} --name ai-detector"
  loop:
    - fake-news-backend:latest
    - fake-news-frontend:latest

- name: Create namespace if it doesn't exist
  command: kubectl create namespace fake-news-app
  ignore_errors: yes

- name: Apply Kubernetes manifests
  command: "kubectl apply -f /home/ubuntu/ai-fake-news-detector/k8s/ -n fake-news-app"
