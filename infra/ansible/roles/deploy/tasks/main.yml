- name: Clone the repository
  git:
    repo: "{{ repo_url }}"
    dest: /home/ubuntu/ai-fake-news-detector
    force: yes

- name: Create host model directory
  file:
    path: /mnt/data/model
    state: directory
    mode: '0777'
    owner: ubuntu
    group: ubuntu
  become: true

- name: Check if Kind cluster exists
  command: kind get clusters
  register: kind_clusters
  changed_when: false

- name: Create Kind cluster if not exists
  command: "kind create cluster --name ai-detector --config /home/ubuntu/ai-fake-news-detector/infra/ansible/kind-config.yaml"
  when: "'ai-detector' not in kind_clusters.stdout"

- name: Create Argo CD Namespace
  command: kubectl create namespace argocd
  ignore_errors: yes

- name: Install Argo CD
  command: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

- name: Wait for Argo CD to be ready
  shell: |
    kubectl wait --namespace argocd \
      --for=condition=ready pod \
      --selector=app.kubernetes.io/name=argocd-server \
      --timeout=180s

- name: Install Nginx Ingress Controller
  command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
  when: "'ai-detector' not in kind_clusters.stdout"

- name: Wait for Ingress Controller to be ready
  shell: |
    kubectl wait --namespace ingress-nginx \
      --for=condition=ready pod \
      --selector=app.kubernetes.io/component=controller \
      --timeout=90s
  ignore_errors: yes
  when: "'ai-detector' not in kind_clusters.stdout"

- name: Build Backend Docker image
  docker_image:
    build:
      path: /home/ubuntu/ai-fake-news-detector/backend
    name: Eshwarsai-07/fake-news-backend
    tag: latest
    source: build
  async: 3600
  poll: 30

- name: Build Frontend Docker image
  docker_image:
    build:
      path: /home/ubuntu/ai-fake-news-detector/frontend
      args:
        VITE_API_URL: "/api"
    name: Eshwarsai-07/fake-news-frontend
    tag: latest
    source: build
  async: 3600
  poll: 30

- name: Prune Docker system to free space
  command: docker system prune -af --volumes
  ignore_errors: yes

- name: Archive and load backend image into Kind (streaming)
  shell: |
    docker save Eshwarsai-07/fake-news-backend:latest | kind load image-archive /dev/stdin --name ai-detector
  args:
    executable: /bin/bash

- name: Archive and load frontend image into Kind (streaming)
  shell: |
    docker save Eshwarsai-07/fake-news-frontend:latest | kind load image-archive /dev/stdin --name ai-detector
  args:
    executable: /bin/bash

- name: Create namespace if it doesn't exist
  command: kubectl create namespace fake-news-app
  ignore_errors: yes

- name: Create backend configuration ConfigMap
  shell: |
    kubectl create configmap backend-config \
      --from-literal=AWS_REGION={{ aws_region }} \
      --from-literal=S3_BUCKET={{ model_bucket }} \
      --from-literal=S3_MODEL_KEY=fake-news-bert \
      -n fake-news-app --dry-run=client -o yaml | kubectl apply -f -

- name: Create MongoDB Atlas secret
  shell: |
    kubectl create secret generic mongodb-atlas-secret \
      --from-literal=MONGODB_URI={{ mongodb_uri }} \
      -n fake-news-app --dry-run=client -o yaml | kubectl apply -f -
  when: mongodb_uri is defined and mongodb_uri != ""

- name: Apply Kubernetes manifests
  command: "kubectl apply -f /home/ubuntu/ai-fake-news-detector/k8s/ -n fake-news-app"

- name: Expose Argo CD API Server via NodePort
  command: kubectl patch svc argocd-server -n argocd -p '{"spec":{"type":"NodePort","ports":[{"port":80,"targetPort":8080,"nodePort":8080,"name":"http"},{"port":443,"targetPort":8080,"nodePort":30443,"name":"https"}]}}'
  ignore_errors: yes
